<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Scan...</title>
    <style>
        /* --- Mobile Responsive Styles --- */
        body { 
            font-family: 'Inter', sans-serif; 
            text-align: center; 
            background: #FFF7ED; 
            color: #7C2D12; 
            padding: 20px; /* Reduced padding for mobile */
            margin: 0;
        }
        .container { 
            max-width: 400px; /* Smaller max-width for better mobile display */
            margin: 50px auto; 
            padding: 2rem; 
            background: white; 
            border-radius: 12px; 
            border: 1px solid #FFEDD5;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); /* Added shadow for better UI */
        }
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #EA580C; 
            border-radius: 50%; 
            width: 30px; 
            height: 30px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- Added Styles for Back Button --- */
        .back-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #EA580C;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: 500;
            transition: background 0.3s;
        }
        .back-btn:hover {
            background-color: #C2410C;
        }
        
        /* Hide loader on success/error */
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <h2 id="status">Processing request...</h2>
        <div id="loader" class="loader"></div>
        <p id="details">Updating library records.</p>
        
        <a href="client.html" id="backBtn" class="back-btn hidden">Back to Catalog</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, update, get } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBh1s2S6rZe9zK4DLWpZUcpXtXZolEBQlI",
            authDomain: "webapp-e8b28.firebaseapp.com",
            projectId: "webapp-e8b28",
            storageBucket: "webapp-e8b28.firebasestorage.app",
            messagingSenderId: "126884302653",
            appId: "1:126884302653:web:2e0ab14def6bad3361ff54",
            measurementId: "G-GJVK5R349Q"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Get parameters from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('student');
        const bookId = urlParams.get('bookId');
        
        const statusEl = document.getElementById('status');
        const detailsEl = document.getElementById('details');
        const loaderEl = document.getElementById('loader');
        const backBtn = document.getElementById('backBtn');

        // Function to show results and the back button
        function showResult(status, details) {
            statusEl.innerText = status;
            detailsEl.innerText = details;
            loaderEl.classList.add('hidden');
            backBtn.classList.remove('hidden');
        }

        if (studentId && bookId) {
            const bookRef = ref(db, 'library/books/' + bookId);
            
            get(bookRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const bookData = snapshot.val();
                    let issuedTo = bookData.issuedTo || [];

                    if (!issuedTo.includes(studentId)) {
                        issuedTo.push(studentId);
                        
                        update(bookRef, { issuedTo: issuedTo }).then(() => {
                            showResult("Success!", `Book issued to Student ID: ${studentId}`);
                        });
                    } else {
                        showResult("Already Borrowed", "This student already has this book.");
                    }
                } else {
                    showResult("Error", "Book not found in database.");
                }
            }).catch((error) => {
                showResult("Error", "Database connection failed.");
                console.error(error);
            });
        } else {
            showResult("Error", "Invalid QR Code data.");
        }
    </script>
</body>
</html>